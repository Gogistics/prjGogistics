'''
Created on Jul 23, 2014

@author: Alan Tai
'''
import webapp2
from models.models_gcm import GCMClientRegID
import json
import httplib2
import logging

class GCMReceiveRegIDHandler(webapp2.RequestHandler):
    ''' handle received id '''
    def get(self):
        reg_id = self.request.get('registrationId')
        user_name = self.request.get('userName')
        
        new_reg_id = GCMClientRegID(id = reg_id)
        new_reg_id.reg_id = reg_id
        new_reg_id.user_name = user_name
        
        return 'ID: %s' % reg_id
    
class GCMSendHandler(webapp2.RequestHandler):
    ''' setup GCM send method '''
    def post(self):
        API_KEY = 'AIzaSyA7tGq5_OGeRARVbrKhm9lZvUjhgd-ncU4'
        headers = {'Content-Type': 'application/json' , 'Authorization':'key=%s'} % API_KEY
        conn = httplib2.HTTPSConnectionWithTimeout('android.googleapis.com')
        
        #loop through registered id then send messages to registered devices
        reg_ids = GCMClientRegID.query()
        if reg_ids.count() > 0:
            for reg_id in reg_ids:
                params = {}
                params['data'] = {'user_name': reg_id.user_name}
                params['registration_ids'] = reg_id.reg_id
                json_parame = json.dumps(params)
                conn.request('POST', '/gcm/send', json_parame, headers)
            
        conn.close()
        return
    
#dispatchers
app = webapp2.WSGIApplication([('/gcm_reg_id_handler', GCMReceiveRegIDHandler),('/gcm_send_message', GCMSendHandler)], debug =True)
        
#log 
logging.getLogger().setLevel(logging.DEBUG)
        